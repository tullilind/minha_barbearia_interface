<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Selecionar Unidade - Minha Barbearia</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FFFFFF", "background-dark": "#121212", "text-primary": "#FFFFFF", "text-secondary": "#A8A8A8", "button-bg": "#FFFFFF", "button-text": "#000000", "input-bg": "rgba(255, 255, 255, 0.05)", "input-border": "rgba(255, 255, 255, 0.2)",
                    },
                    fontFamily: { display: "Spline Sans" },
                    borderRadius: { DEFAULT: "0.5rem", full: "9999px" }
                }
            }
        };
    </script>

    <script type="importmap">
    {
        "imports": {
            "axios": "https://esm.sh/axios"
        }
    }
    </script>

    <style>
        .material-symbols-outlined { font-size: 24px; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .skeleton { background: rgba(255,255,255,0.05); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>

    <script>
        // Segurança: Se não tiver token, volta pro login
        if (!localStorage.getItem('token')) {
            window.location.href = 'index.html';
        }
    </script>
</head>

<body class="bg-background-dark font-display text-text-primary flex flex-col min-h-screen p-6">

    <div class="flex items-center gap-4 mb-8 fade-in">
        <button onclick="window.history.back()" class="h-10 w-10 rounded-full bg-input-bg flex items-center justify-center hover:bg-white/10 transition">
            <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <div>
            <h1 class="text-xl font-bold">Unidades</h1>
            <p class="text-text-secondary text-sm">Onde você quer cortar?</p>
        </div>
    </div>

    <div id="container-unidades" class="flex flex-col gap-4 w-full max-w-sm mx-auto fade-in">
        
        <div id="loading" class="flex flex-col gap-4">
            <div class="h-24 w-full rounded-2xl skeleton"></div>
            <div class="h-24 w-full rounded-2xl skeleton"></div>
        </div>

        <p id="msgErro" class="text-red-500 text-center text-sm hidden"></p>

    </div>

    <script type="module">
        import api from './adds/apiBase.js';

        const Sistema = {
            listarUnidades: async () => {
                try {
                    // CORREÇÃO DO ERRO 401 AQUI:
                    const token = localStorage.getItem('token');
                    
                    if (!token) {
                        window.location.href = 'index.html';
                        return;
                    }

                    // Envia o token no cabeçalho (headers)
                    const response = await api.get('/api/unidades?ativo=true', {
                        headers: { 
                            'Authorization': `Bearer ${token}` 
                        }
                    });
                    return response.data;
                } catch (error) {
                    console.error("Erro API:", error);
                    // Se der erro 401 mesmo enviando o token, o token expirou
                    if (error.response && error.response.status === 401) {
                        localStorage.clear();
                        window.location.href = 'index.html';
                    }
                    return { sucesso: false, erro: "Falha ao carregar unidades." };
                }
            },
            
            selecionar: (id, nome) => {
                localStorage.setItem('unidade_id', id);
                localStorage.setItem('unidade_nome', nome);
                // Redireciona para escolha de profissional ou serviço
                // window.location.href = 'profissionais.html'; 
                alert(`Você escolheu: ${nome}. (Próxima tela: Profissionais)`);
            }
        };

        window.selecionarUnidade = Sistema.selecionar;

        document.addEventListener("DOMContentLoaded", async () => {
            const container = document.getElementById('container-unidades');
            const loading = document.getElementById('loading');
            const msgErro = document.getElementById('msgErro');

            const res = await Sistema.listarUnidades();
            loading.classList.add('hidden');

            if (res && res.sucesso && res.dados) {
                if (res.dados.length === 0) {
                    msgErro.innerText = "Nenhuma unidade encontrada.";
                    msgErro.classList.remove('hidden');
                    return;
                }

                res.dados.forEach(unidade => {
                    const card = document.createElement('button');
                    card.className = "w-full bg-input-bg border border-input-border rounded-2xl p-5 flex items-center justify-between hover:bg-white/5 transition text-left group mb-3";
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="h-12 w-12 rounded-full bg-white/10 flex items-center justify-center text-primary shrink-0">
                                <span class="material-symbols-outlined">storefront</span>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold text-primary">${unidade.nome}</h2>
                                <p class="text-sm text-text-secondary line-clamp-1">${unidade.endereco}</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-text-secondary">chevron_right</span>
                    `;

                    card.onclick = () => window.selecionarUnidade(unidade.id, unidade.nome);
                    container.appendChild(card);
                });
            } else {
                msgErro.innerText = res.erro || "Erro ao conectar.";
                msgErro.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>