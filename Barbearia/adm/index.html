<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Bioteste Online</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FFFFFF", "background-dark": "#121212", "text-primary": "#FFFFFF", "text-secondary": "#A8A8A8", "button-bg": "#FFFFFF", "button-text": "#000000", "input-bg": "rgba(255, 255, 255, 0.05)", "input-border": "rgba(255, 255, 255, 0.2)",
                    },
                    fontFamily: { display: "Spline Sans" },
                    borderRadius: { DEFAULT: "0.5rem", full: "9999px" }
                }
            }
        };
    </script>

    <script type="importmap">
    {
        "imports": {
            "axios": "https://esm.sh/axios"
        }
    }
    </script>

    <style>
        .material-symbols-outlined { font-size: 24px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="bg-background-dark font-display text-text-primary flex flex-col items-center justify-center min-h-screen p-4 gap-6">

    <div class="w-full max-w-sm relative">
        
        <div id="view-login" class="fade-in">
            <div class="flex justify-center mb-10">
                <img src="logo.png" alt="Logo Barbearia" class="h-32 w-auto object-contain drop-shadow-lg">
            </div>

            <h1 class="text-4xl font-bold text-center pb-8">Bem-vindo</h1>
            
            <form id="formLogin" class="flex flex-col gap-4">
                <div>
                    <p class="text-text-secondary pb-2">CPF</p>
                    <input id="loginCpf" type="text" maxlength="14" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6 focus:ring-2 focus:ring-white/50" placeholder="000.000.000-00" required />
                </div>
                <div>
                    <p class="text-text-secondary pb-2">Senha</p>
                    <div class="relative flex items-center">
                        <input id="loginSenha" type="password" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6 pr-12 focus:ring-2 focus:ring-white/50" placeholder="Sua senha" required />
                        <button type="button" onclick="window.togglePass('loginSenha', 'iconLoginEye')" class="absolute right-4 text-input-placeholder">
                            <span id="iconLoginEye" class="material-symbols-outlined">visibility</span>
                        </button>
                    </div>
                </div>
                <button type="submit" id="btnLogin" class="mt-4 w-full rounded-full h-12 bg-button-bg text-button-text font-bold hover:opacity-90 transition">Entrar</button>
                <p id="msgLogin" class="text-red-500 text-center text-sm hidden"></p>
            </form>
            <div class="mt-6 text-center">
                <button onclick="window.showRecuperar()" class="text-text-secondary hover:text-white text-sm">Esqueceu a senha?</button>
            </div>
            <p class="text-text-secondary text-center mt-4">Não tem conta? <button onclick="window.showCadastro()" class="font-bold text-white hover:underline">Cadastre-se</button></p>
        </div>

        <div id="view-cadastro" class="hidden fade-in">
            <div class="flex justify-center mb-6">
                <img src="logo.png" alt="Logo Barbearia" class="h-20 w-auto object-contain opacity-80">
            </div>
            <h1 class="text-3xl font-bold text-center pb-6">Criar Conta</h1>
            <form id="formCadastro" class="flex flex-col gap-3">
                <input id="regNome" type="text" placeholder="Nome Completo" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6" required />
                <input id="regCpf" type="text" maxlength="14" placeholder="CPF" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6" required />
                <input id="regEmail" type="email" placeholder="Email" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6" required />
                <input id="regTelefone" type="tel" placeholder="Telefone (27 99999-9999)" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6" required />
                <div class="relative flex items-center">
                    <input id="regSenha" type="password" placeholder="Senha" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6 pr-12" required />
                    <button type="button" onclick="window.togglePass('regSenha', 'iconRegEye')" class="absolute right-4 text-input-placeholder">
                        <span id="iconRegEye" class="material-symbols-outlined">visibility</span>
                    </button>
                </div>
                <button type="submit" id="btnCadastro" class="mt-4 w-full rounded-full h-12 bg-button-bg text-button-text font-bold hover:opacity-90 transition">Cadastrar</button>
                <p id="msgCadastro" class="text-center text-sm mt-2"></p>
            </form>
            <p class="text-text-secondary text-center mt-6">Já tem conta? <button onclick="window.showLogin()" class="font-bold text-white hover:underline">Entrar</button></p>
        </div>

        <div id="view-recuperar" class="hidden fade-in">
            <h1 class="text-3xl font-bold text-center pb-6">Recuperar Senha</h1>
            <p class="text-text-secondary text-center text-sm mb-6">Digite seu CPF para receber o código.</p>
            <form id="formRecuperar" class="flex flex-col gap-4">
                <input id="recupCpf" type="text" maxlength="14" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6" placeholder="CPF" required />
                <button type="submit" id="btnRecuperar" class="mt-2 w-full rounded-full h-12 bg-button-bg text-button-text font-bold hover:opacity-90 transition">Enviar Código</button>
                <p id="msgRecuperar" class="text-center text-sm mt-2"></p>
            </form>
            <div class="mt-6 text-center">
                <button onclick="window.showLogin()" class="text-text-secondary hover:text-white text-sm">Voltar para Login</button>
            </div>
        </div>

        <div id="view-confirmar" class="hidden fade-in">
            <h1 class="text-3xl font-bold text-center pb-6">Nova Senha</h1>
            <form id="formConfirmar" class="flex flex-col gap-4">
                <input id="confCpf" type="text" maxlength="14" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-secondary h-12 px-6 cursor-not-allowed" placeholder="CPF" readonly />
                <input id="confToken" type="text" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6" placeholder="Código (Token)" required />
                <div class="relative flex items-center">
                    <input id="confSenha" type="password" class="form-input w-full rounded-full bg-input-bg border-input-border text-text-primary h-12 px-6 pr-12" placeholder="Nova Senha" required />
                    <button type="button" onclick="window.togglePass('confSenha', 'iconConfEye')" class="absolute right-4 text-input-placeholder">
                        <span id="iconConfEye" class="material-symbols-outlined">visibility</span>
                    </button>
                </div>
                <button type="submit" id="btnConfirmar" class="mt-2 w-full rounded-full h-12 bg-button-bg text-button-text font-bold hover:opacity-90 transition">Alterar Senha</button>
                <p id="msgConfirmar" class="text-center text-sm mt-2"></p>
            </form>
            <div class="mt-6 text-center">
                <button onclick="window.showRecuperar()" class="text-text-secondary hover:text-white text-sm">Voltar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // CORREÇÃO: Importando com tudo minúsculo para evitar erro 404 no Vercel/Linux
        import api from './adds/apibase.js';

        const Sistema = {
            login: async (cpf, senha) => {
                try {
                    const response = await api.post('/api/auth/login', { cpf: cpf.replace(/\D/g, ''), senha });
                    return response.data;
                } catch (error) { return Sistema.tratarErro(error); }
            },
            registrar: async (dados) => {
                try {
                    dados.cpf = dados.cpf.replace(/\D/g, '');
                    const response = await api.post('/api/auth/clientes/registrar', dados);
                    return response.data;
                } catch (error) { return Sistema.tratarErro(error); }
            },
            solicitarRecuperacao: async (cpf) => {
                try {
                    const response = await api.post('/api/auth/recuperar-senha/solicitar', { cpf: cpf.replace(/\D/g, '') });
                    return response.data;
                } catch (error) { return Sistema.tratarErro(error); }
            },
            confirmarRecuperacao: async (dados) => {
                try {
                    dados.cpf = dados.cpf.replace(/\D/g, '');
                    const response = await api.post('/api/auth/recuperar-senha/confirmar', dados);
                    return response.data;
                } catch (error) { return Sistema.tratarErro(error); }
            },
            tratarErro: (error) => {
                if (error.response && error.response.data) return error.response.data;
                return { sucesso: false, erro: "Erro de conexão." };
            },
            mascaraCPF: (v) => {
                if(!v) return "";
                return v.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})/,'$1-$2').replace(/(-\d{2})\d+?$/,'$1');
            }
        };

        // UI & Navegação
        const views = ['view-login', 'view-cadastro', 'view-recuperar', 'view-confirmar'];
        function changeView(viewId) {
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        window.showLogin = () => changeView('view-login');
        window.showCadastro = () => changeView('view-cadastro');
        window.showRecuperar = () => changeView('view-recuperar');
        window.showConfirmar = () => changeView('view-confirmar');
        
        window.togglePass = (inputId, iconId) => {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') { input.type = 'text'; icon.innerText = 'visibility_off'; } 
            else { input.type = 'password'; icon.innerText = 'visibility'; }
        };

        // Máscaras de CPF
        ;['loginCpf', 'regCpf', 'recupCpf', 'confCpf'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', e => e.target.value = Sistema.mascaraCPF(e.target.value));
        });

        // --- LOGIN (Com Redirecionamento para TERMO) ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('msgLogin');
            btn.innerText = "Verificando..."; msg.classList.add('hidden');

            const res = await Sistema.login(document.getElementById('loginCpf').value, document.getElementById('loginSenha').value);
            
            if (res.sucesso) {
                // SALVA OS DADOS DO USUÁRIO E TOKEN
                localStorage.setItem('token', res.dados.token);
                localStorage.setItem('usuario', JSON.stringify(res.dados.usuario));
                
                // REDIRECIONA PARA A PÁGINA DE TERMOS
                window.location.href = 'termo.ar.barbearia.html';
            } else {
                msg.innerText = res.erro || "Credenciais inválidas."; msg.classList.remove('hidden'); btn.innerText = "Entrar";
            }
        });

        // --- CADASTRO ---
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnCadastro');
            const msg = document.getElementById('msgCadastro');
            btn.innerText = "Cadastrando..."; msg.innerText = "";

            const dados = {
                nome: document.getElementById('regNome').value,
                cpf: document.getElementById('regCpf').value,
                email: document.getElementById('regEmail').value,
                telefone: document.getElementById('regTelefone').value.replace(/\D/g, ''),
                senha: document.getElementById('regSenha').value
            };

            const res = await Sistema.registrar(dados);
            if (res.sucesso) {
                msg.className = "text-green-500 text-center text-sm mt-2 font-bold";
                msg.innerText = "Sucesso! Faça login.";
                setTimeout(() => { 
                    document.getElementById('formCadastro').reset(); 
                    window.showLogin(); 
                    document.getElementById('loginCpf').value = dados.cpf; 
                }, 1500);
            } else {
                msg.className = "text-red-500 text-center text-sm mt-2"; msg.innerText = res.erro || "Erro.";
            }
            btn.innerText = "Cadastrar";
        });

        // --- RECUPERAÇÃO ---
        document.getElementById('formRecuperar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnRecuperar');
            const msg = document.getElementById('msgRecuperar');
            const cpf = document.getElementById('recupCpf').value;
            btn.innerText = "Enviando..."; msg.innerText = "";

            const res = await Sistema.solicitarRecuperacao(cpf);
            if (res.sucesso) {
                msg.className = "text-green-500 text-center text-sm mt-2 font-bold";
                msg.innerText = "Código enviado!";
                document.getElementById('confCpf').value = cpf;
                setTimeout(() => { window.showConfirmar(); msg.innerText = ""; }, 1500);
            } else {
                msg.className = "text-red-500 text-center text-sm mt-2"; msg.innerText = res.erro || "Erro.";
            }
            btn.innerText = "Enviar Código";
        });

        // --- CONFIRMAR SENHA ---
        document.getElementById('formConfirmar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnConfirmar');
            const msg = document.getElementById('msgConfirmar');
            btn.innerText = "Alterando..."; msg.innerText = "";

            const dados = {
                cpf: document.getElementById('confCpf').value,
                token: document.getElementById('confToken').value,
                senha_nova: document.getElementById('confSenha').value
            };

            const res = await Sistema.confirmarRecuperacao(dados);
            if (res.sucesso) {
                msg.className = "text-green-500 text-center text-sm mt-2 font-bold";
                msg.innerText = "Senha alterada! Faça login.";
                setTimeout(() => { 
                    document.getElementById('formConfirmar').reset();
                    document.getElementById('formRecuperar').reset();
                    window.showLogin(); 
                }, 2000);
            } else {
                msg.className = "text-red-500 text-center text-sm mt-2"; msg.innerText = res.erro || "Token inválido.";
            }
            btn.innerText = "Alterar Senha";
        });
    </script>
</body>
</html>